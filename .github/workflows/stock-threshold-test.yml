name: Stock Threshold Plugin Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8, 3.9, 3.10, 3.11]

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-django
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Test with pytest
      run: |
        pytest

  docker-test-stable:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v3

    - name: Build and run Docker container (stable)
      run: |
        # Pull InvenTree stable image
        docker pull inventree/inventree:stable
        
        # Create a test directory
        mkdir -p test_plugin
        
        # Copy plugin files to test directory
        cp -r InvenTree/plugins/stock_threshold test_plugin/
        
        # Create a docker-compose.yml file
        cat > docker-compose.yml << EOF
        version: '3'
        
        services:
          inventree:
            image: inventree/inventree:stable
            ports:
              - "8000:8000"
            volumes:
              - ./test_plugin:/plugins/stock_threshold
            environment:
              - INVENTREE_PLUGINS_ENABLED=True
              - INVENTREE_PLUGIN_STOCKTHRESHOLD_ENABLED=True
              - DJANGO_SUPERUSER_USERNAME=admin
              - DJANGO_SUPERUSER_EMAIL=admin@example.com
              - DJANGO_SUPERUSER_PASSWORD=password
        EOF
        
        # Start the container
        docker-compose up -d
        
        # Wait for the container to start
        sleep 60
        
        # Check if the container is running
        docker ps
        
        # Initialize database
        docker exec $(docker-compose ps -q inventree) python manage.py migrate
        docker exec $(docker-compose ps -q inventree) python manage.py createsuperuser --noinput
        
        # Check plugin installation
        docker exec $(docker-compose ps -q inventree) python manage.py check
        
        # Stop the container
        docker-compose down

  docker-test-v012:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v3

    - name: Build and run Docker container (v0.12.x)
      run: |
        # Pull InvenTree v0.12.x image
        docker pull inventree/inventree:v0.12.8
        
        # Create a test directory
        mkdir -p test_plugin
        
        # Copy plugin files to test directory
        cp -r InvenTree/plugins/stock_threshold test_plugin/
        
        # Create a docker-compose.yml file
        cat > docker-compose.yml << EOF
        version: '3'
        
        services:
          inventree:
            image: inventree/inventree:v0.12.8
            ports:
              - "8000:8000"
            volumes:
              - ./test_plugin:/plugins/stock_threshold
            environment:
              - INVENTREE_PLUGINS_ENABLED=True
              - INVENTREE_PLUGIN_STOCKTHRESHOLD_ENABLED=True
              - DJANGO_SUPERUSER_USERNAME=admin
              - DJANGO_SUPERUSER_EMAIL=admin@example.com
              - DJANGO_SUPERUSER_PASSWORD=password
        EOF
        
        # Start the container
        docker-compose up -d
        
        # Wait for the container to start
        sleep 60
        
        # Check if the container is running
        docker ps
        
        # Initialize database
        docker exec $(docker-compose ps -q inventree) python manage.py migrate
        docker exec $(docker-compose ps -q inventree) python manage.py createsuperuser --noinput
        
        # Check plugin installation
        docker exec $(docker-compose ps -q inventree) python manage.py check
        
        # Stop the container
        docker-compose down
