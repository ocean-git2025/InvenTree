# Stock Threshold Plugin Tests
# This workflow tests the stock threshold plugin against the latest InvenTree docker image

name: Stock Threshold Plugin Tests

on:
  push:
    branches:
      - "stable"
      - "master"
    paths:
      - "src/backend/InvenTree/plugins/stock_threshold/**"
  pull_request:
    branches:
      - "stable"
      - "master"
    paths:
      - "src/backend/InvenTree/plugins/stock_threshold/**"
  workflow_dispatch:

permissions:
  contents: read

env:
  DOCKER_IMAGE: inventree/inventree:latest
  PLUGIN_NAME: StockThreshold
  PLUGIN_PATH: src/backend/InvenTree/plugins/stock_threshold

jobs:
  test-plugin:
    name: Test Stock Threshold Plugin
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: inventree
          POSTGRES_PASSWORD: inventree
          POSTGRES_DB: inventree
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Pull latest InvenTree docker image
        run: docker pull ${{ env.DOCKER_IMAGE }}

      - name: Create test directories
        run: |
          mkdir -p ${{ runner.temp }}/inventree/data
          mkdir -p ${{ runner.temp }}/inventree/static
          mkdir -p ${{ runner.temp }}/inventree/media

      - name: Install plugin dependencies
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:${{ github.workspace }} \
            -w ${{ github.workspace }} \
            ${{ env.DOCKER_IMAGE }} \
            pip install -r src/backend/requirements.txt

      - name: Run plugin tests
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:${{ github.workspace }} \
            -v ${{ runner.temp }}/inventree/data:/home/inventree/data \
            -v ${{ runner.temp }}/inventree/static:/home/inventree/static \
            -v ${{ runner.temp }}/inventree/media:/home/inventree/media \
            -e INVENTREE_DB_ENGINE=postgresql \
            -e INVENTREE_DB_NAME=inventree \
            -e INVENTREE_DB_USER=inventree \
            -e INVENTREE_DB_PASSWORD=inventree \
            -e INVENTREE_DB_HOST=host.docker.internal \
            -e INVENTREE_DB_PORT=5432 \
            -e INVENTREE_PLUGINS_ENABLED=True \
            -e INVENTREE_PLUGINS_STOCKTHRESHOLD_ENABLED=True \
            --network host \
            -w ${{ github.workspace }}/src/backend/InvenTree \
            ${{ env.DOCKER_IMAGE }} \
            python manage.py test plugins.stock_threshold --verbosity=2
        env:
          DOCKER_HOST: tcp://localhost:2375

      - name: Test plugin installation
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:${{ github.workspace }} \
            -v ${{ runner.temp }}/inventree/data:/home/inventree/data \
            -v ${{ runner.temp }}/inventree/static:/home/inventree/static \
            -v ${{ runner.temp }}/inventree/media:/home/inventree/media \
            -e INVENTREE_DB_ENGINE=postgresql \
            -e INVENTREE_DB_NAME=inventree \
            -e INVENTREE_DB_USER=inventree \
            -e INVENTREE_DB_PASSWORD=inventree \
            -e INVENTREE_DB_HOST=host.docker.internal \
            -e INVENTREE_DB_PORT=5432 \
            --network host \
            -w ${{ github.workspace }}/src/backend/InvenTree \
            ${{ env.DOCKER_IMAGE }} \
            python manage.py check --deploy

      - name: Test plugin API endpoints
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:${{ github.workspace }} \
            -v ${{ runner.temp }}/inventree/data:/home/inventree/data \
            -v ${{ runner.temp }}/inventree/static:/home/inventree/static \
            -v ${{ runner.temp }}/inventree/media:/home/inventree/media \
            -e INVENTREE_DB_ENGINE=postgresql \
            -e INVENTREE_DB_NAME=inventree \
            -e INVENTREE_DB_USER=inventree \
            -e INVENTREE_DB_PASSWORD=inventree \
            -e INVENTREE_DB_HOST=host.docker.internal \
            -e INVENTREE_DB_PORT=5432 \
            -e INVENTREE_PLUGINS_ENABLED=True \
            -e INVENTREE_PLUGINS_STOCKTHRESHOLD_ENABLED=True \
            --network host \
            -w ${{ github.workspace }}/src/backend/InvenTree \
            ${{ env.DOCKER_IMAGE }} \
            python -c "
import os
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'InvenTree.settings')

import django
django.setup()

from rest_framework.test import APIClient
from django.contrib.auth import get_user_model

# Create test user and log in
User = get_user_model()
user = User.objects.create_superuser('admin', 'admin@example.com', 'password')

client = APIClient()
client.login(username='admin', password='password')

# Test plugin API endpoints
print('Testing plugin API endpoints...')

# Test list endpoint
response = client.get('/api/plugins/stockthreshold/thresholds/')
print(f'List endpoint status: {response.status_code}')
assert response.status_code == 200, f'Expected 200, got {response.status_code}'

print('All API tests passed!')
"
        env:
          DOCKER_HOST: tcp://localhost:2375

  lint-plugin:
    name: Lint Plugin Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install linting tools
        run: |
          pip install flake8 black isort

      - name: Run flake8
        run: |
          flake8 ${{ env.PLUGIN_PATH }} --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 ${{ env.PLUGIN_PATH }} --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Check black formatting
        run: |
          black --check ${{ env.PLUGIN_PATH }}

      - name: Check isort formatting
        run: |
          isort --check-only ${{ env.PLUGIN_PATH }}

  stable-compatibility:
    name: Stable Branch Compatibility
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout stable branch
        uses: actions/checkout@v4
        with:
          ref: stable

      - name: Verify plugin compatibility
        run: |
          # Check that plugin files exist in stable branch
          if [ ! -d "${{ env.PLUGIN_PATH }}" ]; then
            echo "Plugin directory does not exist in stable branch"
            exit 1
          fi
          
          # Check for required files
          required_files=("__init__.py" "api.py")
          for file in "${required_files[@]}"; do
            if [ ! -f "${{ env.PLUGIN_PATH }}/$file" ]; then
              echo "Required file $file not found"
              exit 1
            fi
          done
          
          echo "Plugin is compatible with stable branch"
